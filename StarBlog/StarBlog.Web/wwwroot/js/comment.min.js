new Vue({el:"#vue-comment",data:{comments:[],total:0,page:1,pageSize:5,search:"",sortBy:"",refreshLoading:!0,submitLoading:!1,emailDisabled:!1,emailOtpDisabled:!1,getEmailOtpDisabled:!1,getEmailOtpLoading:!1,userNameDisabled:!0,userNameLoading:!1,urlDisabled:!0,urlLoading:!1,contentDisabled:!0,submitDisabled:!0,replyDisabled:!0,replyComment:null,getEmailOtpText:"获取",otpInterval:null,form:{parentId:"",postId:POST_ID,userName:"",email:"",emailOtp:"",url:"",content:""},formRules:{userName:[{required:!0,message:"请输入用户名称",trigger:"blur"},{min:2,max:20,message:"长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"邮箱格式不正确"}],emailOtp:[{required:!0,message:"请输入邮箱验证码",trigger:"change"},{len:4,message:"长度 4 个字符",trigger:"change"}],url:[{type:"url",message:"请输入正确的url",trigger:"blur"}],content:[{required:!0,message:"请输入评论内容",trigger:"blur"},{min:1,max:300,message:"长度 在 1 到 300 个字符",trigger:"blur"}]}},created:async function(){await this.getComments(),this.refreshLoading=!1},methods:{getEmailOtp(s){return new Promise((t,e)=>{axios.get("/Api/Comment/GetEmailOtp?email="+s).then(e=>t(e.data)).catch(e=>t(e.response.data))})},getAnonymousUser(s,a){return new Promise((t,e)=>{axios.get(`/Api/Comment/GetAnonymousUser?email=${s}&otp=`+a).then(e=>t(e.data)).catch(e=>t(e.response.data))})},getComments(){let s={PostId:POST_ID,Page:this.page,PageSize:this.pageSize};return this.search&&(s.Search=this.search),this.sortBy&&(s.SortBy=this.sortBy),new Promise((t,e)=>{axios.get("/Api/Comment",{params:s}).then(e=>{this.comments=e.data.data.map(e=>{var t={...e,anonymousUser:{...e.anonymousUser,createdTime:dayjs(e.anonymousUser.createdTime).format("YYYY-MM-DD"),updatedTime:dayjs(e.anonymousUser.updatedTime).format("YYYY-MM-DD")},createdTime:dayjs(e.createdTime).format("YYYY-MM-DD"),updatedTime:dayjs(e.updatedTime).format("YYYY-MM-DD"),avatar:"/Api/PicLib/Random/100/100?Seed="+e.anonymousUserId};return e.parent&&(t.replyUser=e.parent.anonymousUser.name),t}),this.total=e.data.pagination.totalItemCount,t(e)}).catch(e=>{console.log(e);e=e.response.data;t(e)})})},submitComment(s){return new Promise((t,e)=>{axios.post("/Api/Comment",{...s}).then(e=>t(e.data)).catch(e=>t(e.response.data))})},async handleRefresh(){this.refreshLoading=!0,await this.getComments(),this.refreshLoading=!1},async handleGetEmailOtp(){if(this.form.email){this.getEmailOtpLoading=!0;var t=await this.getEmailOtp(this.form.email);if(this.getEmailOtpLoading=!1,t.successful){this.$message.success(t.message);let e=300;this.getEmailOtpText=e+"s",this.otpInterval=setInterval(()=>{0<--e?(this.getEmailOtpText=e+"s",this.getEmailOtpDisabled=!0):(e=300,this.getEmailOtpText="获取",this.otpInterval&&clearInterval(this.otpInterval),this.getEmailOtpDisabled=!1)},1e3)}else this.$message.error(t.message)}else this.$message.error("请输入邮箱地址！")},async handleEmailOtpChange(e){console.log("handleEmailOtpChange",e),0===this.form.email?.length||e.length<4||(this.userNameLoading=!0,this.urlLoading=!0,e=await this.getAnonymousUser(this.form.email,e),console.log(e),e.successful?(e.data.anonymousUser&&(this.form.userName=e.data.anonymousUser.name,this.form.url=e.data.anonymousUser.url),this.form.emailOtp=e.data.newOtp,this.getEmailOtpDisabled=!0,this.emailDisabled=!0,this.emailOtpDisabled=!0,this.userNameDisabled=!1,this.urlDisabled=!1,this.contentDisabled=!1,this.submitDisabled=!1,this.replyDisabled=!1):this.$message.error(e.message),this.userNameLoading=!1,this.urlLoading=!1)},handleUrlBlur(){this.form.url.startsWith("http")||(this.form.url="http://"+this.form.url)},handleReset(){this.$refs.form.resetFields(),this.otpInterval&&clearInterval(this.otpInterval),this.getEmailOtpText="获取",this.emailDisabled=!1,this.emailOtpDisabled=!1,this.getEmailOtpDisabled=!1,this.userNameDisabled=!0,this.urlDisabled=!0,this.contentDisabled=!0,this.submitDisabled=!0,this.replyDisabled=!0,this.form.parentId="",this.replyComment=null},async handleSubmit(){this.$refs.form.validate(async e=>{var t;e&&(this.submitLoading=!0,(e=await this.submitComment(this.form)).successful?(this.$message.success(e.message),t=""+this.form.email,this.handleReset(),this.form.email=t):this.$message.error(e.message),this.submitLoading=!1,await this.getComments())})},async handleSizeChange(e){this.pageSize=e,await this.handleRefresh()},async handleCurrentChange(e){this.page=e,await this.handleRefresh()},async handleReply(e){this.replyComment=e,this.form.parentId=e.id,this.$refs.content.focus()},handleReplyTagClose(){this.form.parentId="",this.replyComment=null}}});